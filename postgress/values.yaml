fullnameOverride: postgresql

auth:
  enablePostgresUser: true      # enable postgres superuser (needed for backup/restore)
  username: admin               # your application user
  database: chms                # default DB to create

  # Map secret keys properly
  secretKeys:
    adminPasswordKey: postgres-password   # superuser password
    userPasswordKey: password             # app user password

architecture: standalone

primary:
  resourcesPreset: none

  persistence:
    enabled: true
    storageClass: local-path     # ðŸ”¥ important: ensures PVC uses local path
    accessModes:
      - ReadWriteOnce
    size: 8Gi
    mountPath: /bitnami/postgresql

  service:
    type: NodePort               # OK for local testing

  networkPolicy:
    enabled: false

  pdb:
    create: false

# Disable read replicas for local setup
readReplicas:
  replicaCount: 0

persistentVolumeClaimRetentionPolicy:
  enabled: true

# Create PVC for storing backups
extraObjects:
  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: postgres-local-backups
      namespace: postgresql
    spec:
      accessModes:
        - ReadWriteOnce
      storageClassName: local-path
      resources:
        requests:
          storage: 5Gi

# NEW SECTION: dedicated backup user
extraInitScripts:
  - name: create-backup-user.sql
    script: |
      -- Create a read-only backup user (SRE-safe)
      DO
      $do$
      BEGIN
        IF NOT EXISTS (
          SELECT FROM pg_catalog.pg_roles WHERE rolname = 'backup_user'
        ) THEN
          CREATE ROLE backup_user WITH LOGIN PASSWORD 'BackupPass123!';
        END IF;
      END
      $do$;

      -- Grant minimal permissions for backup
      GRANT CONNECT ON DATABASE chms TO backup_user;
      GRANT USAGE ON SCHEMA public TO backup_user;
      GRANT SELECT ON ALL TABLES IN SCHEMA public TO backup_user;
      ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO backup_user;
